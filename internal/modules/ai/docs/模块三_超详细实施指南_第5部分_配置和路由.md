# æ¨¡å—ä¸‰ AI å¾®æœåŠ¡/å°å·¥å…· - è¶…è¯¦ç»†å®æ–½æŒ‡å—ï¼ˆç¬¬5éƒ¨åˆ†ï¼šé…ç½®å’Œè·¯ç”±ï¼‰

## ç¬¬äº”éƒ¨åˆ†ï¼šé…ç½®å’Œè·¯ç”±

è¿™éƒ¨åˆ†å®ç°ç³»ç»Ÿé…ç½®å’ŒHTTPè·¯ç”±æ³¨å†Œï¼Œè´Ÿè´£ï¼š
- æ·»åŠ å¾®æœåŠ¡é…ç½®ç»“æ„
- ä¿®æ”¹é…ç½®æ–‡ä»¶
- æ³¨å†ŒHTTPå’ŒWebSocketè·¯ç”±
- åˆ›å»ºWebSocketè®¤è¯ä¸­é—´ä»¶
- åˆå§‹åŒ–æ‰€æœ‰ä¾èµ–

---

## 5.1 é…ç½®æ–‡ä»¶ä¿®æ”¹

### 5.1.1 ä¿®æ”¹ config.go

#### æ–‡ä»¶è·¯å¾„
```
internal/config/config.go
```

#### ä¿®æ”¹è¯´æ˜

**åœ¨ç°æœ‰çš„ `AIConfig` ç»“æ„ä½“ä¸­æ·»åŠ  `Microservice` å­—æ®µ**

```go
// æ‰¾åˆ° AIConfig ç»“æ„ä½“ï¼Œæ·»åŠ ä»¥ä¸‹å­—æ®µ

type AIConfig struct {
	// ... ç°æœ‰å­—æ®µï¼ˆä¿æŒä¸å˜ï¼‰
	ChatModel   ChatModelConfig   `toml:"chatModel"`
	Embedding   EmbeddingConfig   `toml:"embedding"`
	
	// ========== æ–°å¢ï¼šå¾®æœåŠ¡é…ç½® ==========
	Microservice MicroserviceConfig `toml:"microservice"`
}
```

**æ·»åŠ æ–°çš„é…ç½®ç»“æ„ä½“**

åœ¨ `config.go` æ–‡ä»¶æœ«å°¾æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```go
// ========== å¾®æœåŠ¡é…ç½®ç»“æ„ ==========

// MicroserviceConfig å¾®æœåŠ¡æ€»é…ç½®
//
// è®¾è®¡åŸç†ï¼š
// 1. æ¯ä¸ªåŠŸèƒ½ç‹¬ç«‹é…ç½®ï¼ˆinput_predictionã€polishã€digestï¼‰
// 2. æ”¯æŒå…¨å±€å¼€å…³ï¼ˆEnabledï¼‰
// 3. æ”¯æŒè°ƒç”¨æ—¥å¿—å¼€å…³ï¼ˆLogCallsï¼‰
type MicroserviceConfig struct {
	Enabled bool `toml:"enabled"` // æ˜¯å¦å¯ç”¨å¾®æœåŠ¡ï¼ˆæ€»å¼€å…³ï¼‰
	LogCalls bool `toml:"log_calls"` // æ˜¯å¦è®°å½•è°ƒç”¨æ—¥å¿—ï¼ˆå¼€å‘ç¯å¢ƒtrueï¼Œç”Ÿäº§ç¯å¢ƒå¯é€‰ï¼‰
	
	// å„åŠŸèƒ½ç‹¬ç«‹é…ç½®
	InputPrediction ServiceModelConfig `toml:"input_prediction"` // æ™ºèƒ½è¾“å…¥é¢„æµ‹
	Polish          ServiceModelConfig `toml:"polish"`           // æ–‡æœ¬æ¶¦è‰²
	Digest          ServiceModelConfig `toml:"digest"`           // æ¶ˆæ¯æ‘˜è¦
}

// ServiceModelConfig å•ä¸ªå¾®æœåŠ¡çš„æ¨¡å‹é…ç½®
//
// è®¾è®¡åŸç†ï¼š
// 1. æ¯ä¸ªåŠŸèƒ½å¯ä»¥ä½¿ç”¨ä¸åŒçš„æ¨¡å‹
// 2. æ”¯æŒä¸åŒçš„ Providerï¼ˆarkã€openaiã€deepseekï¼‰
// 3. æ”¯æŒåŠŸèƒ½ç‰¹å®šçš„å‚æ•°ï¼ˆå¦‚ ContextMessagesï¼‰
//
// é…ç½®ç¤ºä¾‹ï¼š
//   [aiConfig.microservice.input_prediction]
//   provider = "ark"
//   model = "doubao-lite-8k"
//   api_key = "${DOUBAO_API_KEY}"
//   temperature = 0.7
//   max_tokens = 100
type ServiceModelConfig struct {
	// ========== LLM åŸºç¡€é…ç½® ==========
	Provider        string  `toml:"provider"`         // æä¾›å•†ï¼šark/openai/deepseek
	Model           string  `toml:"model"`            // æ¨¡å‹åç§°
	APIKey          string  `toml:"api_key"`          // API Keyï¼ˆæ”¯æŒç¯å¢ƒå˜é‡ï¼‰
	BaseURL         string  `toml:"base_url"`         // API Base URL
	Temperature     float64 `toml:"temperature"`      // æ¸©åº¦ï¼ˆ0-1ï¼‰
	MaxTokens       int     `toml:"max_tokens"`       // æœ€å¤§ Token æ•°
	TimeoutSeconds  int     `toml:"timeout_seconds"`  // è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
	
	// ========== åŠŸèƒ½ç‰¹å®šé…ç½® ==========
	// ä»¥ä¸‹å‚æ•°ä¸ºå¯é€‰ï¼Œä¸åŒåŠŸèƒ½ä½¿ç”¨ä¸åŒå‚æ•°
	
	// æ™ºèƒ½è¾“å…¥é¢„æµ‹ä¸“ç”¨
	ContextMessages  int `toml:"context_messages"`   // ä¸Šä¸‹æ–‡æ¶ˆæ¯æ•°ï¼ˆé»˜è®¤10ï¼‰
	DebounceMsint    int `toml:"debounce_ms"`        // é˜²æŠ–å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼Œé»˜è®¤500ï¼‰
	MaxInputChars    int `toml:"max_input_chars"`    // æœ€å¤§è¾“å…¥å­—ç¬¦ï¼ˆé»˜è®¤500ï¼‰
	CacheTTLSeconds  int `toml:"cache_ttl_seconds"`  // ç¼“å­˜TTLï¼ˆç§’ï¼‰
	
	// æ¶¦è‰²ä¸“ç”¨
	MaxOptions       int `toml:"max_options"`        // æœ€å¤šè¿”å›é€‰é¡¹æ•°ï¼ˆé»˜è®¤3ï¼‰
	
	// æ‘˜è¦ä¸“ç”¨
	MaxMessages      int `toml:"max_messages"`       // æœ€å¤šå¤„ç†æ¶ˆæ¯æ•°ï¼ˆé»˜è®¤200ï¼‰
}
```

### ä»£ç è¯´æ˜

#### 5.1.1.1 è®¾è®¡è¦ç‚¹

##### 1. é…ç½®åˆ†å±‚

```
MicroserviceConfig (æ€»é…ç½®)
â”œâ”€ Enabled (å…¨å±€å¼€å…³)
â”œâ”€ LogCalls (æ—¥å¿—å¼€å…³)
â”œâ”€ InputPrediction (æ™ºèƒ½è¾“å…¥é…ç½®)
â”‚  â”œâ”€ Provider, Model, APIKey ... (é€šç”¨é…ç½®)
â”‚  â””â”€ ContextMessages, DebounceMs ... (åŠŸèƒ½ç‰¹å®šé…ç½®)
â”œâ”€ Polish (æ¶¦è‰²é…ç½®)
â”‚  â”œâ”€ Provider, Model, APIKey ... (é€šç”¨é…ç½®)
â”‚  â””â”€ MaxOptions ... (åŠŸèƒ½ç‰¹å®šé…ç½®)
â””â”€ Digest (æ‘˜è¦é…ç½®)
   â”œâ”€ Provider, Model, APIKey ... (é€šç”¨é…ç½®)
   â””â”€ MaxMessages ... (åŠŸèƒ½ç‰¹å®šé…ç½®)
```

##### 2. ç¯å¢ƒå˜é‡æ”¯æŒ

```toml
# config.toml ä¸­å¯ä»¥ä½¿ç”¨ç¯å¢ƒå˜é‡
api_key = "${DOUBAO_API_KEY}"

# è¿è¡Œæ—¶ä¼šè‡ªåŠ¨æ›¿æ¢
export DOUBAO_API_KEY="your-api-key"
```

##### 3. å¯é€‰å‚æ•°

```go
// æŸäº›å‚æ•°åªåœ¨ç‰¹å®šåŠŸèƒ½ä¸­ä½¿ç”¨
type ServiceModelConfig struct {
    // é€šç”¨å‚æ•°ï¼ˆæ‰€æœ‰åŠŸèƒ½éƒ½éœ€è¦ï¼‰
    Provider string
    Model string
    
    // å¯é€‰å‚æ•°ï¼ˆåªåœ¨ç‰¹å®šåŠŸèƒ½ä¸­ä½¿ç”¨ï¼‰
    ContextMessages int  // åªç”¨äº input_prediction
    MaxOptions int       // åªç”¨äº polish
    MaxMessages int      // åªç”¨äº digest
}
```

---

### 5.1.2 ä¿®æ”¹ config_local.toml

#### æ–‡ä»¶è·¯å¾„
```
configs/config_local.toml
```

#### æ·»åŠ å†…å®¹

åœ¨ç°æœ‰é…ç½®æ–‡ä»¶çš„ `[aiConfig]` æ®µåé¢æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```toml
# ========== AI å¾®æœåŠ¡é…ç½® ==========
[aiConfig.microservice]
enabled = true        # æ˜¯å¦å¯ç”¨å¾®æœåŠ¡åŠŸèƒ½
log_calls = true      # æ˜¯å¦è®°å½•è°ƒç”¨æ—¥å¿—ï¼ˆå¼€å‘ç¯å¢ƒå»ºè®®trueï¼‰

  # ---------- æ™ºèƒ½è¾“å…¥é¢„æµ‹é…ç½® ----------
  [aiConfig.microservice.input_prediction]
  provider = "ark"                                        # æä¾›å•†ï¼ˆark/openaiï¼‰
  model = "doubao-lite-8k"                               # æ¨¡å‹åç§°
  api_key = "${DOUBAO_API_KEY}"                          # API Keyï¼ˆä»ç¯å¢ƒå˜é‡è¯»å–ï¼‰
  base_url = "https://ark.cn-beijing.volces.com/api/v3"  # API åœ°å€
  temperature = 0.7                                      # æ¸©åº¦ï¼ˆ0-1ï¼Œè¶Šé«˜è¶Šéšæœºï¼‰
  max_tokens = 100                                       # æœ€å¤§ç”Ÿæˆ Token æ•°
  timeout_seconds = 5                                    # è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
  
  # åŠŸèƒ½ç‰¹å®šé…ç½®
  context_messages = 10      # ä¸Šä¸‹æ–‡æ¶ˆæ¯æ•°
  debounce_ms = 500          # é˜²æŠ–å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
  max_input_chars = 500      # æœ€å¤§è¾“å…¥å­—ç¬¦
  cache_ttl_seconds = 300    # ç¼“å­˜ TTLï¼ˆç§’ï¼Œ5åˆ†é’Ÿï¼‰

  # ---------- æ–‡æœ¬æ¶¦è‰²é…ç½® ----------
  [aiConfig.microservice.polish]
  provider = "ark"
  model = "doubao-lite-8k"
  api_key = "${DOUBAO_API_KEY}"
  base_url = "https://ark.cn-beijing.volces.com/api/v3"
  temperature = 0.8          # æ¶¦è‰²éœ€è¦æ›´é«˜çš„æ¸©åº¦ï¼ˆæ›´æœ‰åˆ›æ„ï¼‰
  max_tokens = 200           # æ¶¦è‰²éœ€è¦æ›´å¤š Token
  timeout_seconds = 10
  
  # åŠŸèƒ½ç‰¹å®šé…ç½®
  max_options = 3            # æœ€å¤šè¿”å›3ä¸ªæ¶¦è‰²é€‰é¡¹
  cache_ttl_seconds = 1800   # ç¼“å­˜ TTLï¼ˆç§’ï¼Œ30åˆ†é’Ÿï¼‰

  # ---------- æ¶ˆæ¯æ‘˜è¦é…ç½® ----------
  [aiConfig.microservice.digest]
  provider = "ark"
  model = "doubao-pro-32k"   # æ‘˜è¦ä½¿ç”¨æ›´å¼ºçš„æ¨¡å‹ï¼ˆæ”¯æŒæ›´é•¿ä¸Šä¸‹æ–‡ï¼‰
  api_key = "${DOUBAO_API_KEY}"
  base_url = "https://ark.cn-beijing.volces.com/api/v3"
  temperature = 0.5          # æ‘˜è¦éœ€è¦æ›´ä½çš„æ¸©åº¦ï¼ˆæ›´å‡†ç¡®ï¼‰
  max_tokens = 500           # æ‘˜è¦éœ€è¦æ›´å¤š Token
  timeout_seconds = 15
  
  # åŠŸèƒ½ç‰¹å®šé…ç½®
  max_messages = 200         # æœ€å¤šå¤„ç†200æ¡æ¶ˆæ¯
  cache_ttl_seconds = 600    # ç¼“å­˜ TTLï¼ˆç§’ï¼Œ10åˆ†é’Ÿï¼‰
```

### é…ç½®è¯´æ˜

#### 5.1.2.1 ç¯å¢ƒå˜é‡è®¾ç½®

åœ¨å¯åŠ¨åº”ç”¨å‰ï¼Œéœ€è¦è®¾ç½®ç¯å¢ƒå˜é‡ï¼š

```bash
# Linux/Mac
export DOUBAO_API_KEY="your-doubao-api-key"

# Windows (PowerShell)
$env:DOUBAO_API_KEY = "your-doubao-api-key"

# Windows (CMD)
set DOUBAO_API_KEY=your-doubao-api-key
```

#### 5.1.2.2 å‚æ•°è°ƒä¼˜å»ºè®®

| åŠŸèƒ½ | æ¸©åº¦ | MaxTokens | æ¨¡å‹é€‰æ‹© | ç†ç”± |
|------|------|-----------|----------|------|
| **æ™ºèƒ½è¾“å…¥** | 0.7 | 100 | doubao-lite-8k | éœ€è¦å¹³è¡¡å‡†ç¡®æ€§å’Œå¤šæ ·æ€§ |
| **æ¶¦è‰²** | 0.8 | 200 | doubao-lite-8k | éœ€è¦æ›´æœ‰åˆ›æ„çš„è¡¨è¾¾ |
| **æ‘˜è¦** | 0.5 | 500 | doubao-pro-32k | éœ€è¦å‡†ç¡®æ€§ï¼Œæ”¯æŒé•¿ä¸Šä¸‹æ–‡ |

#### 5.1.2.3 æˆæœ¬ä¼˜åŒ–

```toml
# å¼€å‘ç¯å¢ƒï¼šä½¿ç”¨å°æ¨¡å‹é™ä½æˆæœ¬
[aiConfig.microservice.input_prediction]
model = "doubao-lite-8k"  # Â¥0.0003/1K tokens

# ç”Ÿäº§ç¯å¢ƒï¼šæ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©
[aiConfig.microservice.digest]
model = "doubao-pro-32k"  # Â¥0.003/1K tokensï¼ˆ10å€ä»·æ ¼ï¼Œä½†è´¨é‡æ›´å¥½ï¼‰
```

---

## 5.2 è·¯ç”±æ³¨å†Œ

### 5.2.1 ä¿®æ”¹ https_server.go

#### æ–‡ä»¶è·¯å¾„
```
api/http/https_server.go
```

#### ä¿®æ”¹ä½ç½®

æ‰¾åˆ°è·¯ç”±æ³¨å†Œéƒ¨åˆ†ï¼ˆé€šå¸¸åœ¨ `InitRouters` å‡½æ•°ä¸­ï¼‰ï¼Œåœ¨ç°æœ‰AIè·¯ç”±ä¹‹åæ·»åŠ å¾®æœåŠ¡è·¯ç”±ã€‚

#### å®Œæ•´æ·»åŠ ä»£ç 

```go
// åœ¨ InitRouters å‡½æ•°ä¸­ï¼Œæ‰¾åˆ° AI è·¯ç”±æ³¨å†Œéƒ¨åˆ†ï¼Œæ·»åŠ ä»¥ä¸‹ä»£ç 

func InitRouters(router *gin.Engine, conf *config.Config) {
	// ... ç°æœ‰ä»£ç ï¼ˆä¿æŒä¸å˜ï¼‰
	
	// ===== ç°æœ‰ AI Assistant è·¯ç”± =====
	// authed.GET("/ai/assistant/sessions", aiAssistantH.ListSessions)
	// authed.POST("/ai/assistant/chat", aiAssistantH.Chat)
	// ... å…¶ä»–ç°æœ‰è·¯ç”±
	
	// ========== æ–°å¢ï¼šAI å¾®æœåŠ¡è·¯ç”± ==========
	//
	// è®¾è®¡è¦ç‚¹ï¼š
	// 1. æ£€æŸ¥é…ç½®æ˜¯å¦å¯ç”¨
	// 2. åˆå§‹åŒ–æ‰€æœ‰ä¾èµ–ï¼ˆæŒ‰é¡ºåºï¼‰
	// 3. æ³¨å†Œ HTTP å’Œ WebSocket è·¯ç”±
	if conf.AIConfig.Microservice.Enabled {
		zlog.Info("initializing AI microservice...")
		
		// ========== Step 1: åˆå§‹åŒ–å¤šæ¨¡å‹æ˜ å°„ ==========
		//
		// è®¾è®¡è¦ç‚¹ï¼š
		// - ä¸ºæ¯ä¸ªæœåŠ¡ï¼ˆinput_prediction/polish/digestï¼‰åˆ›å»ºç‹¬ç«‹çš„æ¨¡å‹å®ä¾‹
		// - æ¯ä¸ªæ¨¡å‹å¯ä»¥ä½¿ç”¨ä¸åŒçš„é…ç½®å’Œ Provider
		// - æˆæœ¬ä¼˜å…ˆï¼ˆæ ¹æ®æœåŠ¡ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„æ¨¡å‹ï¼‰
		microChatModels, err := aiLLM.NewMicroserviceChatModels(ctx, conf)
		if err != nil {
			zlog.Fatal("failed to init microservice chat models",
				zap.Error(err))
		}
		zlog.Info("microservice chat models initialized",
			zap.Int("model_count", len(microChatModels)),
			zap.String("input_model", conf.AIConfig.Microservice.InputPrediction.Model),
			zap.String("polish_model", conf.AIConfig.Microservice.Polish.Model),
			zap.String("digest_model", conf.AIConfig.Microservice.Digest.Model))
		
		// ========== Step 2: åˆå§‹åŒ– Redis Cache ==========
		//
		// è®¾è®¡è¦ç‚¹ï¼š
		// - å¤ç”¨ç°æœ‰çš„ Redis è¿æ¥
		// - å¦‚æœ Redis ä¸å¯ç”¨ï¼Œä¼  nilï¼ˆç¦ç”¨ç¼“å­˜ï¼‰
		var redisCache pipeline.CacheInterface
		if initial.RedisClient != nil {
			redisCache = NewRedisCache(initial.RedisClient)
			zlog.Info("redis cache initialized for microservice")
		} else {
			zlog.Warn("redis not available, cache disabled for microservice")
		}
		
		// ========== Step 3: åˆå§‹åŒ– MicroservicePipeline ==========
		//
		// è®¾è®¡è¦ç‚¹ï¼š
		// - Pipeline è´Ÿè´£æ’ä»¶ç®¡ç†å’Œ LLM è°ƒç”¨
		// - ä¼ å…¥å¤šæ¨¡å‹æ˜ å°„ï¼Œæ”¯æŒæ¯ä¸ªæœåŠ¡ä½¿ç”¨ä¸åŒæ¨¡å‹
		// - è‡ªåŠ¨æ³¨å†Œé»˜è®¤æ’ä»¶ï¼ˆinput_predictionã€polishã€digestï¼‰
		microPipeline := aiPipeline.NewMicroservicePipeline(
			microChatModels,  // å¤šæ¨¡å‹æ˜ å°„
			redisCache,
		)
		zlog.Info("microservice pipeline initialized")
		
		// ========== Step 4: åˆå§‹åŒ– Service ==========
		//
		// è®¾è®¡è¦ç‚¹ï¼š
		// - Service è´Ÿè´£ä¸šåŠ¡é€»è¾‘ç¼–æ’
		// - ä¾èµ–æ³¨å…¥ Pipeline
		microService := aiService.NewAIMicroserviceService(microPipeline)
		zlog.Info("microservice service initialized")
		
		// ========== Step 5: åˆå§‹åŒ– Handlers ==========
		//
		// è®¾è®¡è¦ç‚¹ï¼š
		// - HTTP Handler å¤„ç† Polishã€Digest
		// - WebSocket Handler å¤„ç† PredictStream
		microHTTPHandler := aiHTTP.NewMicroserviceHandler(microService)
		microWSHandler := aiWS.NewMicroserviceWSHandler(microService)
		zlog.Info("microservice handlers initialized")
		
		// ========== Step 6: æ³¨å†Œè·¯ç”± ==========
		//
		// è®¾è®¡è¦ç‚¹ï¼š
		// - æ‰€æœ‰è·¯ç”±éƒ½åœ¨ /ai/microservice ä¸‹
		// - ä½¿ç”¨ authed ä¸­é—´ä»¶ï¼ˆéœ€è¦ JWT è®¤è¯ï¼‰
		// - WebSocket ä½¿ç”¨ GET æ–¹æ³•
		aiMicroGroup := authed.Group("/ai/microservice")
		{
			// HTTP æ¥å£ï¼ˆéæµå¼ï¼‰
			aiMicroGroup.POST("/predict", microHTTPHandler.Predict)  // æ™ºèƒ½è¾“å…¥é¢„æµ‹ï¼ˆæµ‹è¯•ç”¨ï¼‰
			aiMicroGroup.POST("/polish", microHTTPHandler.Polish)    // æ–‡æœ¬æ¶¦è‰²
			aiMicroGroup.POST("/digest", microHTTPHandler.Digest)    // æ¶ˆæ¯æ‘˜è¦
			
			// WebSocket æ¥å£ï¼ˆæµå¼ï¼‰
			aiMicroGroup.GET("/input/ws", microWSHandler.InputPrediction) // æ™ºèƒ½è¾“å…¥é¢„æµ‹ï¼ˆæµå¼ï¼‰
		}
		
		zlog.Info("AI microservice routes registered",
			zap.String("base_path", "/ai/microservice"))
	} else {
		zlog.Info("AI microservice is disabled in config")
	}
	
	// ... å…¶ä»–è·¯ç”±
}
```

#### éœ€è¦æ–°å¢çš„è¾…åŠ©å‡½æ•°

åœ¨ `https_server.go` æ–‡ä»¶ä¸­æ·»åŠ  Redis Cache é€‚é…å™¨ï¼š

```go
// ========== Redis Cache é€‚é…å™¨ ==========

// RedisCache Redis ç¼“å­˜å®ç°ï¼ˆå®ç° pipeline.CacheInterfaceï¼‰
//
// è®¾è®¡åŸç†ï¼š
// - é€‚é…å™¨æ¨¡å¼ï¼šå°† Redis Client é€‚é…ä¸º Pipeline éœ€è¦çš„æ¥å£
// - ç®€å•å°è£…ï¼šåªå®ç° Getã€Setã€Delete ä¸‰ä¸ªåŸºæœ¬æ–¹æ³•
type RedisCache struct {
	client *redis.Client
}

// NewRedisCache åˆ›å»º Redis ç¼“å­˜é€‚é…å™¨
func NewRedisCache(client *redis.Client) *RedisCache {
	return &RedisCache{client: client}
}

// Get è·å–ç¼“å­˜
func (c *RedisCache) Get(ctx context.Context, key string) (string, error) {
	val, err := c.client.Get(ctx, key).Result()
	if err == redis.Nil {
		return "", fmt.Errorf("key not found")
	}
	return val, err
}

// Set è®¾ç½®ç¼“å­˜
func (c *RedisCache) Set(ctx context.Context, key string, value string, ttl time.Duration) error {
	return c.client.Set(ctx, key, value, ttl).Err()
}

// Delete åˆ é™¤ç¼“å­˜
func (c *RedisCache) Delete(ctx context.Context, key string) error {
	return c.client.Del(ctx, key).Err()
}
```

### ä»£ç è¯´æ˜

#### 5.2.1.1 åˆå§‹åŒ–é¡ºåº

```
1. LightweightChatModel (LLM æ¨¡å‹)
   â†“
2. RedisCache (ç¼“å­˜)
   â†“
3. MicroservicePipeline (Pipeline)
   â†“
4. AIMicroserviceService (Service)
   â†“
5. Handlers (HTTP + WebSocket)
   â†“
6. è·¯ç”±æ³¨å†Œ
```

**ä¸ºä»€ä¹ˆè¿™æ ·é¡ºåºï¼Ÿ**
- âœ… ä¾èµ–å…³ç³»æ¸…æ™°ï¼ˆåº•å±‚ â†’ ä¸Šå±‚ï¼‰
- âœ… åˆå§‹åŒ–å¤±è´¥æ—¶èƒ½å¿«é€Ÿå®šä½
- âœ… æ—¥å¿—è¾“å‡ºæœ‰åº

#### 5.2.1.2 é”™è¯¯å¤„ç†ç­–ç•¥

```go
// LLM åˆå§‹åŒ–å¤±è´¥ â†’ è‡´å‘½é”™è¯¯ï¼ˆæ— æ³•æä¾›æœåŠ¡ï¼‰
if err != nil {
    zlog.Fatal("failed to init lightweight chat model", zap.Error(err))
}

// Redis åˆå§‹åŒ–å¤±è´¥ â†’ è­¦å‘Šï¼ˆç¦ç”¨ç¼“å­˜ï¼Œä½†å¯ä»¥ç»§ç»­ï¼‰
if initial.RedisClient != nil {
    redisCache = NewRedisCache(initial.RedisClient)
} else {
    zlog.Warn("redis not available, cache disabled")
    redisCache = nil // Pipeline ä¼šå¤„ç† nil çš„æƒ…å†µ
}
```

#### 5.2.1.3 è·¯ç”±è®¾è®¡

| è·¯å¾„ | æ–¹æ³• | åŠŸèƒ½ | ç±»å‹ |
|------|------|------|------|
| `/ai/microservice/predict` | POST | æ™ºèƒ½è¾“å…¥é¢„æµ‹ | HTTPï¼ˆæµ‹è¯•ç”¨ï¼‰ |
| `/ai/microservice/polish` | POST | æ–‡æœ¬æ¶¦è‰² | HTTP |
| `/ai/microservice/digest` | POST | æ¶ˆæ¯æ‘˜è¦ | HTTP |
| `/ai/microservice/input/ws` | GET | æ™ºèƒ½è¾“å…¥é¢„æµ‹ | WebSocketï¼ˆæ¨èï¼‰ |

---

## 5.3 WebSocket ä¸­é—´ä»¶ï¼ˆå¯é€‰ï¼‰

### 5.3.1 åˆ›å»º WebSocket è®¤è¯ä¸­é—´ä»¶

#### æ–‡ä»¶è·¯å¾„
```
internal/middleware/ws_auth.go
```

#### å®Œæ•´ä»£ç 

```go
package middleware

import (
	"net/http"
	"strings"

	"OmniLink/internal/middleware/jwt"
	"OmniLink/pkg/zlog"

	"github.com/gin-gonic/gin"
	"go.uber.org/zap"
)

// WSAuthMiddleware WebSocket è¿æ¥æ—¶çš„ JWT éªŒè¯
//
// è®¾è®¡åŸç†ï¼š
// 1. WebSocket æ— æ³•åœ¨æ¡æ‰‹æ—¶è®¾ç½®è‡ªå®šä¹‰ Header
// 2. æ”¯æŒä¸‰ç§è®¤è¯æ–¹å¼ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š
//    - URL Query å‚æ•°ï¼š?token=xxxï¼ˆæ¨èï¼‰
//    - HTTP Headerï¼šAuthorization: Bearer xxx
//    - Cookieï¼šauth_token=xxx
// 3. éªŒè¯æˆåŠŸåå°† uuid å­˜å…¥ Context
//
// ä½¿ç”¨åœºæ™¯ï¼š
// - WebSocket è·¯ç”±éœ€è¦ JWT è®¤è¯
// - å…¼å®¹å¤šç§å®¢æˆ·ç«¯å®ç°
//
// ä½¿ç”¨æ–¹å¼ï¼š
//   aiMicroGroup.GET("/input/ws", WSAuthMiddleware(), microWSHandler.InputPrediction)
func WSAuthMiddleware() gin.HandlerFunc {
	return func(c *gin.Context) {
		var token string

		// ========== Step 1: ä» URL Query è·å– Token ==========
		//
		// ä¼˜å…ˆçº§æœ€é«˜ï¼Œå› ä¸º WebSocket å®¢æˆ·ç«¯æœ€å®¹æ˜“ä½¿ç”¨
		// ç¤ºä¾‹ï¼šws://localhost:8080/ai/microservice/input/ws?token=xxx
		token = c.Query("token")

		// ========== Step 2: ä» HTTP Header è·å– Token ==========
		//
		// å¦‚æœ Query æ²¡æœ‰ï¼Œå°è¯•ä» Header è·å–
		// ç¤ºä¾‹ï¼šAuthorization: Bearer xxx
		if token == "" {
			authHeader := c.GetHeader("Authorization")
			if strings.HasPrefix(authHeader, "Bearer ") {
				token = strings.TrimPrefix(authHeader, "Bearer ")
			}
		}

		// ========== Step 3: ä» Cookie è·å– Token ==========
		//
		// å¦‚æœå‰ä¸¤è€…éƒ½æ²¡æœ‰ï¼Œå°è¯•ä» Cookie è·å–
		if token == "" {
			cookie, err := c.Cookie("auth_token")
			if err == nil {
				token = cookie
			}
		}

		// ========== Step 4: éªŒè¯ Token ==========
		if token == "" {
			zlog.Warn("websocket auth failed: missing token",
				zap.String("remote_addr", c.Request.RemoteAddr))
			c.JSON(http.StatusUnauthorized, gin.H{"error": "missing token"})
			c.Abort()
			return
		}

		// è§£æå’ŒéªŒè¯ Token
		claims, err := jwt.ParseToken(token)
		if err != nil {
			zlog.Warn("websocket auth failed: invalid token",
				zap.Error(err),
				zap.String("remote_addr", c.Request.RemoteAddr))
			c.JSON(http.StatusUnauthorized, gin.H{"error": "invalid token"})
			c.Abort()
			return
		}

		// ========== Step 5: å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ ==========
		//
		// å°† uuid å­˜å…¥ Contextï¼Œä¾› Handler ä½¿ç”¨
		c.Set("uuid", claims.UUID)

		zlog.Info("websocket auth success",
			zap.String("uuid", claims.UUID),
			zap.String("remote_addr", c.Request.RemoteAddr))

		c.Next()
	}
}
```

### ä»£ç è¯´æ˜

#### 5.3.1.1 è®¤è¯æ–¹å¼å¯¹æ¯”

| æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | ä½¿ç”¨åœºæ™¯ |
|------|------|------|----------|
| **URL Query** | ç®€å•ï¼Œæµè§ˆå™¨æ”¯æŒ | Token æš´éœ²åœ¨ URL | WebSocket æ¨è |
| **HTTP Header** | å®‰å…¨ï¼Œä¸æš´éœ² | éœ€è¦ JS è®¾ç½® | AJAX è¯·æ±‚æ¨è |
| **Cookie** | è‡ªåŠ¨å‘é€ | è·¨åŸŸé—®é¢˜ | åŒåŸŸåœºæ™¯ |

#### 5.3.1.2 ä½¿ç”¨æ–¹å¼

```go
// æ–¹å¼1ï¼šå…¨å±€åº”ç”¨ï¼ˆæ‰€æœ‰ WebSocket éƒ½éœ€è¦è®¤è¯ï¼‰
authed := router.Group("/api", WSAuthMiddleware())

// æ–¹å¼2ï¼šå•ä¸ªè·¯ç”±åº”ç”¨ï¼ˆæ¨èï¼‰
router.GET("/ws", WSAuthMiddleware(), handler.WebSocket)

// æ–¹å¼3ï¼šä¸ä½¿ç”¨ä¸­é—´ä»¶ï¼ˆåœ¨ Handler å†…éƒ¨è®¤è¯ï¼‰
router.GET("/ws", handler.WebSocket) // Handler å†…éƒ¨è‡ªå·±å¤„ç†è®¤è¯
```

---

## ç¬¬äº”éƒ¨åˆ†æ€»ç»“

### å·²å®Œæˆçš„å†…å®¹

1. âœ… **é…ç½®æ–‡ä»¶ä¿®æ”¹**
   - config.go æ·»åŠ é…ç½®ç»“æ„ï¼ˆ~80è¡Œï¼‰
   - config_local.toml æ·»åŠ é…ç½®ç¤ºä¾‹ï¼ˆ~60è¡Œï¼‰

2. âœ… **è·¯ç”±æ³¨å†Œ**
   - https_server.go åˆå§‹åŒ–å’Œè·¯ç”±æ³¨å†Œï¼ˆ~100è¡Œï¼‰
   - Redis Cache é€‚é…å™¨ï¼ˆ~30è¡Œï¼‰

3. âœ… **WebSocket ä¸­é—´ä»¶**
   - ws_auth.go JWT è®¤è¯ä¸­é—´ä»¶ï¼ˆ~80è¡Œï¼‰

### ä»£ç ç»Ÿè®¡

- **æ€»è¡Œæ•°**: ~350è¡Œï¼ˆå«æ³¨é‡Šï¼‰
- **é…ç½®è¡Œæ•°**: ~140è¡Œ
- **ä»£ç è¡Œæ•°**: ~210è¡Œ

### æ ¸å¿ƒç‰¹æ€§

- âœ… **é…ç½®åˆ†å±‚**: æ€»å¼€å…³ + åŠŸèƒ½é…ç½®
- âœ… **ç¯å¢ƒå˜é‡æ”¯æŒ**: æ•æ„Ÿä¿¡æ¯ä¸ç¡¬ç¼–ç 
- âœ… **ä¾èµ–æ³¨å…¥**: æ¸…æ™°çš„åˆå§‹åŒ–é¡ºåº
- âœ… **å¤šç§è®¤è¯æ–¹å¼**: Query/Header/Cookie
- âœ… **ä¼˜é›…é™çº§**: Redis ä¸å¯ç”¨æ—¶ç¦ç”¨ç¼“å­˜

---

## 5.4 éªŒè¯é…ç½®

### 5.4.1 å¯åŠ¨æ£€æŸ¥

ä¿®æ”¹åï¼Œå¯åŠ¨åº”ç”¨åº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼š

```
INFO  initializing AI microservice...
INFO  lightweight chat model initialized  provider=ark model=doubao-lite-8k
INFO  redis cache initialized for microservice
INFO  microservice pipeline initialized
INFO  microservice service initialized
INFO  microservice handlers initialized
INFO  AI microservice routes registered  base_path=/ai/microservice
```

### 5.4.2 è·¯ç”±éªŒè¯

å¯åŠ¨åï¼Œè®¿é—®ä»¥ä¸‹URLéªŒè¯è·¯ç”±æ˜¯å¦æ³¨å†ŒæˆåŠŸï¼š

```bash
# æŸ¥çœ‹æ‰€æœ‰è·¯ç”±ï¼ˆGin Debug æ¨¡å¼ï¼‰
# åº”è¯¥èƒ½çœ‹åˆ°ï¼š
# [GIN-debug] POST   /ai/microservice/predict
# [GIN-debug] POST   /ai/microservice/polish
# [GIN-debug] POST   /ai/microservice/digest
# [GIN-debug] GET    /ai/microservice/input/ws
```

### 5.4.3 é…ç½®æµ‹è¯•

```bash
# æµ‹è¯•ç¯å¢ƒå˜é‡
echo $DOUBAO_API_KEY  # åº”è¯¥è¾“å‡ºä½ çš„ API Key

# æµ‹è¯•é…ç½®åŠ è½½
# å¯åŠ¨åº”ç”¨ï¼Œæ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰é…ç½®é”™è¯¯
```

---

## ä¸‹ä¸€æ­¥

### å·²å®Œæˆï¼ˆ1-5éƒ¨åˆ†ï¼‰

- âœ… Part 1: æ’ä»¶ç³»ç»Ÿï¼ˆ700è¡Œï¼‰
- âœ… Part 2: Pipelineå±‚ï¼ˆ410è¡Œï¼‰
- âœ… Part 3: Serviceå±‚ï¼ˆ500è¡Œï¼‰
- âœ… Part 4: Handlerå±‚ï¼ˆ400è¡Œï¼‰
- âœ… Part 5: é…ç½®å’Œè·¯ç”±ï¼ˆ350è¡Œï¼‰

**åç«¯æ ¸å¿ƒä»£ç å·²å®Œæˆ**: ~2360è¡Œ

### å¾…å®Œæˆï¼ˆ6-9éƒ¨åˆ†ï¼‰

- ğŸ“ Part 6: æ•°æ®åº“è¿ç§»ï¼ˆ170è¡Œï¼‰
- ğŸ“ Part 7: å‰ç«¯å®ç°ï¼ˆ900è¡Œï¼‰
- ğŸ“ Part 8: æµ‹è¯•æŒ‡å—
- ğŸ“ Part 9: éƒ¨ç½²æ¸…å•

---

## ğŸ‰ é‡è¦é‡Œç¨‹ç¢‘

**æ­å–œï¼åç«¯æ ¸å¿ƒä»£ç å·²å…¨éƒ¨å®Œæˆï¼**

ç°åœ¨æ‚¨å¯ä»¥ï¼š
1. âœ… åˆ›å»ºæ•°æ®åº“è¡¨ï¼ˆPart 6ï¼‰
2. âœ… å¯åŠ¨åç«¯æœåŠ¡
3. âœ… ä½¿ç”¨ Postman æµ‹è¯• API
4. âœ… ä½¿ç”¨ wscat æµ‹è¯• WebSocket

---

## æµ‹è¯•å»ºè®®

åœ¨ç»§ç»­å‰ç«¯å¼€å‘ä¹‹å‰ï¼Œå»ºè®®å…ˆæµ‹è¯•åç«¯ï¼š

```bash
# 1. è®¾ç½®ç¯å¢ƒå˜é‡
export DOUBAO_API_KEY="your-api-key"

# 2. å¯åŠ¨æœåŠ¡
go run cmd/OmniLink/main.go

# 3. æµ‹è¯• HTTP æ¥å£ï¼ˆPostmanï¼‰
POST http://localhost:8080/ai/microservice/polish
Authorization: Bearer <your-jwt-token>
{
  "text": "ç»™æˆ‘å‘ä¸€ä¸‹é‚£ä¸ªæ–‡ä»¶"
}

# 4. æµ‹è¯• WebSocketï¼ˆwscatï¼‰
wscat -c "ws://localhost:8080/ai/microservice/input/ws?token=<your-jwt-token>"
> {"action":"predict","data":{"input":"ä»Šå¤©å¤©æ°”çœŸä¸é”™"}}
```

---

## â“ ä¸‹ä¸€æ­¥é€‰æ‹©

æ‚¨ç°åœ¨å¯ä»¥ï¼š

### é€‰é¡¹1ï¼šç»§ç»­Part 6ï¼ˆæ•°æ®åº“è¿ç§»ï¼‰
- åˆ›å»ºSQLè¿ç§»è„šæœ¬
- æ’å…¥åˆå§‹é…ç½®æ•°æ®
- å¿«é€Ÿå®Œæˆï¼ˆ~100è¡Œï¼‰

### é€‰é¡¹2ï¼šè·³åˆ°Part 7ï¼ˆå‰ç«¯å®ç°ï¼‰
- åˆ›å»ºVueç»„ä»¶
- APIæœåŠ¡å°è£…
- WebSocketç®¡ç†å™¨
- ä»£ç é‡æœ€å¤§ï¼ˆ~900è¡Œï¼‰

### é€‰é¡¹3ï¼šå…ˆæµ‹è¯•åç«¯
- åˆ›å»ºæ‰€æœ‰å¿…è¦çš„ä»£ç æ–‡ä»¶
- è¿è¡Œæµ‹è¯•
- ç¡®ä¿åç«¯æ­£å¸¸å·¥ä½œ

---

è¯·å‘Šè¯‰æˆ‘æ‚¨çš„é€‰æ‹©ï¼
