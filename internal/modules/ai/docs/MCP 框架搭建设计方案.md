ğŸ¯ OmniLink MCP æ¡†æ¶æ­å»ºè®¾è®¡æ–¹æ¡ˆ

ä¸€ã€æ•´ä½“æ¶æ„è®¾è®¡

1.1 æ¶æ„åˆ†å±‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AI Application Layer                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  AssistantService (å·²æœ‰)                              â”‚  â”‚
â”‚  â”‚  + MCPDispatcher (æ–°å¢)                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AI Infrastructure - MCP Layer                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ MCP Client   â”‚  â”‚ Server       â”‚  â”‚ Tool Router     â”‚  â”‚
â”‚  â”‚              â”‚  â”‚ Registry     â”‚  â”‚                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“                    â†“                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å†…ç½® MCP     â”‚  â”‚ å¤–éƒ¨ MCP Server  â”‚  â”‚ OmniLink Core    â”‚
â”‚ Server       â”‚  â”‚ (GitHub, æ—¥å†ç­‰) â”‚  â”‚ Services         â”‚
â”‚ (å°è£…å†…éƒ¨èƒ½åŠ›)â”‚  â”‚                  â”‚  â”‚ (å¥½å‹/ç¾¤/æ¶ˆæ¯)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
---
äºŒã€ç›®å½•ç»“æ„è®¾è®¡
2.1 æ–°å¢ç›®å½•ç»“æ„
internal/modules/ai/
â”œâ”€â”€ application/
â”‚   â””â”€â”€ service/
â”‚       â”œâ”€â”€ assistant_service.go        (å·²æœ‰)
â”‚       â””â”€â”€ mcp_dispatcher.go           (æ–°å¢) - MCP è°ƒåº¦å™¨
â”‚
â”œâ”€â”€ infrastructure/
â”‚   â””â”€â”€ mcp/                            (æ–°å¢æ•´ä¸ªç›®å½•)
â”‚       â”œâ”€â”€ client/
â”‚       â”‚   â”œâ”€â”€ mcp_client.go           - MCP Client æ ¸å¿ƒå®ç°
â”‚       â”‚   â”œâ”€â”€ session_manager.go      - Session ç”Ÿå‘½å‘¨æœŸç®¡ç†
â”‚       â”‚   â”œâ”€â”€ transport_stdio.go      - Stdio ä¼ è¾“å±‚å®ç°
â”‚       â”‚   â””â”€â”€ transport_http.go       - HTTP/SSE ä¼ è¾“å±‚å®ç°
â”‚       â”‚
â”‚       â”œâ”€â”€ server/
â”‚       â”‚   â”œâ”€â”€ builtin_server.go       - å†…ç½® MCP Server å®ç°
â”‚       â”‚   â”œâ”€â”€ tool_registry.go        - å·¥å…·æ³¨å†Œè¡¨
â”‚       â”‚   â””â”€â”€ handlers/
â”‚       â”‚       â”œâ”€â”€ contact_handler.go  - å¥½å‹/è”ç³»äººå·¥å…·
â”‚       â”‚       â”œâ”€â”€ group_handler.go    - ç¾¤ç»„å·¥å…·
â”‚       â”‚       â””â”€â”€ message_handler.go  - æ¶ˆæ¯å·¥å…·
â”‚       â”‚
â”‚       â”œâ”€â”€ registry/
â”‚       â”‚   â”œâ”€â”€ server_registry.go      - Server æ³¨å†Œä¸ç®¡ç†
â”‚       â”‚   â””â”€â”€ server_config.go        - Server é…ç½®åŠ è½½
â”‚       â”‚
â”‚       â”œâ”€â”€ router/
â”‚       â”‚   â”œâ”€â”€ tool_router.go          - å·¥å…·è·¯ç”±å™¨
â”‚       â”‚   â”œâ”€â”€ tool_matcher.go         - å·¥å…·åŒ¹é…ç­–ç•¥
â”‚       â”‚   â””â”€â”€ result_transformer.go   - ç»“æœè½¬æ¢å™¨
â”‚       â”‚
â”‚       â””â”€â”€ types/
â”‚           â”œâ”€â”€ protocol.go             - MCP åè®®ç±»å‹å®šä¹‰
â”‚           â”œâ”€â”€ tool.go                 - Tool å®šä¹‰
â”‚           â””â”€â”€ errors.go               - MCP é”™è¯¯å®šä¹‰
---

ä¸‰ã€MCP é…ç½®ç»“æ„è®¾è®¡ï¼ˆTOMLï¼‰
3.1 é…ç½®æ–‡ä»¶ï¼šconfigs/config.toml
[mcpConfig]
  # MCP å…¨å±€å¼€å…³
  enabled = true
  
  # è°ƒåº¦ç­–ç•¥
  dispatchStrategy = "priority"  # priority | round_robin | random
  
  # è¶…æ—¶é…ç½®
  toolCallTimeoutSeconds = 30
  serverInitTimeoutSeconds = 10
  
  # å†…ç½® Server é…ç½®
  [mcpConfig.builtinServer]
    enabled = true
    name = "omnilink-internal"
    version = "1.0.0"
    description = "OmniLink å†…ç½®èƒ½åŠ›å°è£… (å¥½å‹ã€ç¾¤ã€æ¶ˆæ¯æŸ¥è¯¢)"
    
    # æš´éœ²çš„å·¥å…·ç±»åˆ« (å¯æŒ‰éœ€å¼€å…³)
    enableContactTools = true
    enableGroupTools = true
    enableMessageTools = true
    enableSessionTools = true
  
  # å¤–éƒ¨ MCP Servers é…ç½®
  [[mcpConfig.externalServers]]
    name = "github-mcp"
    enabled = true
    priority = 100
    transport = "stdio"
    
    # Stdio Transport é…ç½®
    [mcpConfig.externalServers.command]
      executable = "npx"
      args = ["-y", "@modelcontextprotocol/server-github"]
      env = [
        "GITHUB_PERSONAL_ACCESS_TOKEN=your_token_here"
      ]
      workdir = ""
  
  [[mcpConfig.externalServers]]
    name = "filesystem-mcp"
    enabled = true
    priority = 90
    transport = "stdio"
    
    [mcpConfig.externalServers.command]
      executable = "npx"
      args = ["-y", "@modelcontextprotocol/server-filesystem", "/path/to/allowed/dir"]
      env = []
  
  [[mcpConfig.externalServers]]
    name = "google-calendar-mcp"
    enabled = false
    priority = 80
    transport = "http"
    
    # HTTP Transport é…ç½®
    [mcpConfig.externalServers.http]
      endpoint = "https://api.example.com/mcp"
      authType = "bearer"  # none | bearer | api_key
      authToken = "your_api_key"
      headers = [
        "X-Custom-Header: value"
      ]


3.2 Go Config ç»“æ„ä½“å®šä¹‰
// internal/config/config.go
type MCPCommandConfig struct {
    Executable string   `toml:"executable"`
    Args       []string `toml:"args"`
    Env        []string `toml:"env"`
    Workdir    string   `toml:"workdir"`
}
type MCPHTTPConfig struct {
    Endpoint   string            `toml:"endpoint"`
    AuthType   string            `toml:"authType"`   // none | bearer | api_key
    AuthToken  string            `toml:"authToken"`
    Headers    []string          `toml:"headers"`
}
type MCPExternalServerConfig struct {
    Name      string             `toml:"name"`
    Enabled   bool               `toml:"enabled"`
    Priority  int                `toml:"priority"`  // æ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜
    Transport string             `toml:"transport"` // stdio | http
    Command   *MCPCommandConfig  `toml:"command"`   // ç”¨äº stdio
    HTTP      *MCPHTTPConfig     `toml:"http"`      // ç”¨äº http
}
type MCPBuiltinServerConfig struct {
    Enabled            bool   `toml:"enabled"`
    Name               string `toml:"name"`
    Version            string `toml:"version"`
    Description        string `toml:"description"`
    EnableContactTools bool   `toml:"enableContactTools"`
    EnableGroupTools   bool   `toml:"enableGroupTools"`
    EnableMessageTools bool   `toml:"enableMessageTools"`
    EnableSessionTools bool   `toml:"enableSessionTools"`
}
type MCPConfig struct {
    Enabled                  bool                       `toml:"enabled"`
    DispatchStrategy         string                     `toml:"dispatchStrategy"`
    ToolCallTimeoutSeconds   int                        `toml:"toolCallTimeoutSeconds"`
    ServerInitTimeoutSeconds int                        `toml:"serverInitTimeoutSeconds"`
    BuiltinServer            MCPBuiltinServerConfig     `toml:"builtinServer"`
    ExternalServers          []MCPExternalServerConfig  `toml:"externalServers"`
}
// æ·»åŠ åˆ°æ€» Config ç»“æ„ä½“
type Config struct {
    MainConfig   `toml:"mainConfig"`
    MysqlConfig  `toml:"mysqlConfig"`
    JwtConfig    `toml:"jwtConfig"`
    MilvusConfig `toml:"milvusConfig"`
    KafkaConfig  `toml:"kafkaConfig"`
    AIConfig     `toml:"aiConfig"`
    LogConfig    `toml:"logConfig"`
    MCPConfig    `toml:"mcpConfig"`  // æ–°å¢
}
---
å››ã€Tool åˆ—è¡¨ä¸æ¥å£å¥‘çº¦è§„èŒƒ
4.1 å†…ç½® MCP Server å·¥å…·è§„èŒƒ
åˆ†ç±» 1: å¥½å‹/è”ç³»äººç®¡ç†å·¥å…· (Contact Tools)
---
ğŸ”¹ contact_list_friends  
è·å–ç”¨æˆ·çš„å¥½å‹åˆ—è¡¨
- è¾“å…¥å‚æ•°:
    {
    tenant_user_id: string  // ç§Ÿæˆ·ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
  }
  
- è¾“å‡ºç»“æœ:
    {
    friends: [
      {
        user_id: string,
        username: string,
        avatar: string,
        status: int
      }
    ],
    total: int
  }
  
---
ğŸ”¹ contact_get_info  
è·å–è”ç³»äººè¯¦ç»†ä¿¡æ¯
- è¾“å…¥å‚æ•°:
    {
    tenant_user_id: string,  // ç§Ÿæˆ·ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
    contact_id: string       // è”ç³»äººIDï¼ˆå¿…å¡«ï¼‰
  }
  
- è¾“å‡ºç»“æœ:
    {
    contact_id: string,
    name: string,
    avatar: string,
    signature: string,
    gender: int,
    birthday: string
  }
  
---
ğŸ”¹ contact_apply  
å‘é€å¥½å‹ç”³è¯·
- è¾“å…¥å‚æ•°:
    {
    tenant_user_id: string,  // ç§Ÿæˆ·ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
    contact_id: string,      // ç›®æ ‡è”ç³»äººIDï¼ˆå¿…å¡«ï¼‰
    message: string          // ç”³è¯·æ¶ˆæ¯ï¼ˆé€‰å¡«ï¼‰
  }
  
- è¾“å‡ºç»“æœ:
    {
    apply_id: string,
    status: string
  }
  
---
ğŸ”¹ contact_list_applications  
è·å–å¾…å¤„ç†çš„å¥½å‹ç”³è¯·
- è¾“å…¥å‚æ•°:
    {
    tenant_user_id: string  // ç§Ÿæˆ·ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
  }
  
- è¾“å‡ºç»“æœ:
    {
    applications: [
      {
        uuid: string,
        user_id: string,
        username: string,
        message: string,
        last_apply_at: string
      }
    ],
    total: int
  }
  
---
ğŸ”¹ contact_accept_application  
é€šè¿‡å¥½å‹ç”³è¯·
- è¾“å…¥å‚æ•°:
    {
    tenant_user_id: string,  // ç§Ÿæˆ·ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
    apply_id: string         // ç”³è¯·IDï¼ˆå¿…å¡«ï¼‰
  }
  
- è¾“å‡ºç»“æœ:
    {
    success: bool,
    message: string
  }
  
---
ğŸ”¹ contact_reject_application  
æ‹’ç»å¥½å‹ç”³è¯·
- è¾“å…¥å‚æ•°:
    {
    tenant_user_id: string,  // ç§Ÿæˆ·ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
    apply_id: string         // ç”³è¯·IDï¼ˆå¿…å¡«ï¼‰
  }
  
- è¾“å‡ºç»“æœ:
    {
    success: bool,
    message: string
  }
  
---
åˆ†ç±» 2: ç¾¤ç»„ç®¡ç†å·¥å…· (Group Tools)
---
ğŸ”¹ group_list_joined  
è·å–ç”¨æˆ·å·²åŠ å…¥çš„ç¾¤åˆ—è¡¨
- è¾“å…¥å‚æ•°:
    {
    tenant_user_id: string  // ç§Ÿæˆ·ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
  }
  
- è¾“å‡ºç»“æœ:
    {
    groups: [
      {
        group_id: string,
        group_name: string,
        avatar: string
      }
    ],
    total: int
  }
  
---
ğŸ”¹ group_get_info  
è·å–ç¾¤ç»„è¯¦ç»†ä¿¡æ¯
- è¾“å…¥å‚æ•°:
    {
    group_id: string  // ç¾¤ç»„IDï¼ˆå¿…å¡«ï¼‰
  }
  
- è¾“å‡ºç»“æœ:
    {
    group_id: string,
    name: string,
    notice: string,
    owner_id: string,
    member_count: int,
    avatar: string,
    status: int,
    created_at: string
  }
  
---
ğŸ”¹ group_list_members  
è·å–ç¾¤æˆå‘˜åˆ—è¡¨
- è¾“å…¥å‚æ•°:
    {
    group_id: string  // ç¾¤ç»„IDï¼ˆå¿…å¡«ï¼‰
  }
  
- è¾“å‡ºç»“æœ:
    {
    members: [
      {
        user_id: string,
        username: string,
        nickname: string,
        avatar: string,
        role: int
      }
    ],
    total: int
  }
  
---
ğŸ”¹ group_create  
åˆ›å»ºæ–°ç¾¤ç»„
- è¾“å…¥å‚æ•°:
    {
    tenant_user_id: string,  // ç§Ÿæˆ·ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
    name: string,            // ç¾¤ç»„åç§°ï¼ˆå¿…å¡«ï¼‰
    notice: string,          // ç¾¤å…¬å‘Šï¼ˆé€‰å¡«ï¼‰
    member_ids: [string]     // åˆå§‹æˆå‘˜IDåˆ—è¡¨ï¼ˆå¿…å¡«ï¼‰
  }
  
- è¾“å‡ºç»“æœ:
    {
    group_id: string,
    name: string,
    owner_id: string,
    member_count: int
  }
  
---
ğŸ”¹ group_invite_members  
é‚€è¯·æˆå‘˜å…¥ç¾¤
- è¾“å…¥å‚æ•°:
    {
    tenant_user_id: string,  // ç§Ÿæˆ·ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
    group_id: string,        // ç¾¤ç»„IDï¼ˆå¿…å¡«ï¼‰
    member_ids: [string]     // å¾…é‚€è¯·æˆå‘˜IDåˆ—è¡¨ï¼ˆå¿…å¡«ï¼‰
  }
  
- è¾“å‡ºç»“æœ:
    {
    success: bool,
    added_count: int
  }
  
---
åˆ†ç±» 3: æ¶ˆæ¯æŸ¥è¯¢å·¥å…· (Message Tools)
---
ğŸ”¹ message_list_private  
è·å–ç§èŠæ¶ˆæ¯è®°å½•
- è¾“å…¥å‚æ•°:
    {
    tenant_user_id: string,  // ç§Ÿæˆ·ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
    contact_id: string,      // è”ç³»äººIDï¼ˆå¿…å¡«ï¼‰
    page: int,               // é¡µç ï¼ˆå¿…å¡«ï¼Œ>= 1ï¼‰
    page_size: int           // æ¯é¡µæ¡æ•°ï¼ˆå¿…å¡«ï¼ŒèŒƒå›´ 1-200ï¼‰
  }
  
- è¾“å‡ºç»“æœ:
    {
    messages: [
      {
        uuid: string,
        send_id: string,
        content: string,
        type: int,
        created_at: string
      }
    ],
    total: int
  }
  
---
ğŸ”¹ message_list_group  
è·å–ç¾¤èŠæ¶ˆæ¯è®°å½•
- è¾“å…¥å‚æ•°:
    {
    tenant_user_id: string,  // ç§Ÿæˆ·ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
    group_id: string,        // ç¾¤ç»„IDï¼ˆå¿…å¡«ï¼‰
    page: int,               // é¡µç ï¼ˆå¿…å¡«ï¼Œ>= 1ï¼‰
    page_size: int           // æ¯é¡µæ¡æ•°ï¼ˆå¿…å¡«ï¼ŒèŒƒå›´ 1-200ï¼‰
  }
  
- è¾“å‡ºç»“æœ:
    {
    messages: [
      {
        uuid: string,
        send_id: string,
        send_name: string,
        content: string,
        type: int,
        created_at: string
      }
    ],
    total: int
  }
  
---
ğŸ”¹ message_search  
æœç´¢æ¶ˆæ¯å†…å®¹
- è¾“å…¥å‚æ•°:
    {
    tenant_user_id: string,  // ç§Ÿæˆ·ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
    keyword: string,         // æœç´¢å…³é”®è¯ï¼ˆå¿…å¡«ï¼‰
    scope: string,           // æœç´¢èŒƒå›´ï¼ˆé€‰å¡«ï¼Œå¦‚ "private" | "group" | "all"ï¼‰
    limit: int               // ç»“æœæ•°é‡é™åˆ¶ï¼ˆå¿…å¡«ï¼ŒèŒƒå›´ 1-100ï¼‰
  }
  
- è¾“å‡ºç»“æœ:
    {
    messages: [
      {
        uuid: string,
        session_id: string,
        content: string,
        created_at: string
      }
    ],
    total: int
  }
  
---
åˆ†ç±» 4: ä¼šè¯ç®¡ç†å·¥å…· (Session Tools)
---
ğŸ”¹ session_list_private  
è·å–ç§èŠä¼šè¯åˆ—è¡¨
- è¾“å…¥å‚æ•°:
    {
    tenant_user_id: string  // ç§Ÿæˆ·ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
  }
  
- è¾“å‡ºç»“æœ:
    {
    sessions: [
      {
        session_id: string,
        contact_id: string,
        last_message: string,
        updated_at: string
      }
    ],
    total: int
  }
  
---
ğŸ”¹ session_list_group  
è·å–ç¾¤èŠä¼šè¯åˆ—è¡¨
- è¾“å…¥å‚æ•°:
    {
    tenant_user_id: string  // ç§Ÿæˆ·ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
  }
  
- è¾“å‡ºç»“æœ:
    {
    sessions: [
      {
        session_id: string,
        group_id: string,
        last_message: string,
        updated_at: string
      }
    ],
    total: int
  }
  
---
ğŸ”¹ session_open  
æ‰“å¼€/åˆ›å»ºä¼šè¯
- è¾“å…¥å‚æ•°:
    {
    tenant_user_id: string,  // ç§Ÿæˆ·ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
    contact_id: string,      // è”ç³»äººIDï¼ˆcontact_id å’Œ group_id äºŒé€‰ä¸€ï¼‰
    group_id: string         // ç¾¤ç»„IDï¼ˆcontact_id å’Œ group_id äºŒé€‰ä¸€ï¼‰
  }
  
- è¾“å‡ºç»“æœ:
    {
    session_id: string,
    can_chat: bool
  }
  
---
å·¥å…·æ•°é‡ç»Ÿè®¡:
- å¥½å‹/è”ç³»äººå·¥å…·: 6 ä¸ª
- ç¾¤ç»„ç®¡ç†å·¥å…·: 5 ä¸ª
- æ¶ˆæ¯æŸ¥è¯¢å·¥å…·: 3 ä¸ª
- ä¼šè¯ç®¡ç†å·¥å…·: 3 ä¸ª
- æ€»è®¡: 17 ä¸ªå·¥å…·

4.2 å·¥å…·æ¥å£å¥‘çº¦è§„èŒƒ (JSON Schema)
æ‰€æœ‰å·¥å…·å¿…é¡»éµå¾ªä»¥ä¸‹å¥‘çº¦ï¼š
å·¥å…·æè¿°è§„èŒƒ (Tool Descriptor)
{
  name: contact_list_friends,
  description: è·å–ç”¨æˆ·çš„å¥½å‹åˆ—è¡¨ï¼Œè¿”å›å¥½å‹åŸºæœ¬ä¿¡æ¯ï¼ˆç”¨æˆ·åã€å¤´åƒã€çŠ¶æ€ï¼‰,
  inputSchema: {
    type: object,
    properties: {
      tenant_user_id: {
        type: string,
        description: ç§Ÿæˆ·ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼Œä»ä¸Šä¸‹æ–‡è·å–ï¼‰
      }
    },
    required: [tenant_user_id]
  }
}
å·¥å…·è°ƒç”¨è¯·æ±‚ (Tool Call Request)
{
  jsonrpc: 2.0,
  id: call-123,
  method: tools/call,
  params: {
    name: contact_list_friends,
    arguments: {
      tenant_user_id: U_20250125_ABC123
    }
  }
}
å·¥å…·è°ƒç”¨å“åº” (Tool Call Response)
æˆåŠŸå“åº”ï¼š
{
  jsonrpc: 2.0,
  id: call-123,
  result: {
    content: [
      {
        type: text,
        text: æ‰¾åˆ° 3 ä½å¥½å‹ï¼š\n1. å¼ ä¸‰ (@zhangsan) - åœ¨çº¿\n2. æå›› (@lisi) - ç¦»çº¿\n3. ç‹äº” (@wangwu) - åœ¨çº¿
      }
    ],
    metadata: {
      friends: [
        { user_id: U_001, username: å¼ ä¸‰, avatar: https://..., status: 0 },
        { user_id: U_002, username: æå››, avatar: https://..., status: 1 },
        { user_id: U_003, username: ç‹äº”, avatar: https://..., status: 0 }
      ],
      total: 3
    }
  }
}
é”™è¯¯å“åº”ï¼š
{
  jsonrpc: 2.0,
  id: call-123,
  result: {
    content: [
      {
        type: text,
        text: æŸ¥è¯¢å¤±è´¥ï¼šç”¨æˆ·æœªç™»å½•æˆ– token æ— æ•ˆ
      }
    ],
    isError: true
  }
}

4.3 å·¥å…·å‘½åè§„èŒƒ
- æ ¼å¼: {category}_{action}_{object}
  - category: contact | group | message | session
  - action: list | get | create | update | delete | search | send | accept | reject
  - object: friends | info | members | applications | private | group
- ç¤ºä¾‹:
  - âœ… contact_list_friends (æ¸…æ™°)
  - âœ… group_invite_members (åŠ¨å®¾ç»“æ„)
  - âŒ getFriends (ä¸ç¬¦åˆè›‡å½¢å‘½å)
  - âŒ contact-list (ç¼ºå°‘å¯¹è±¡)
4.4 è¾“å…¥éªŒè¯è§„èŒƒ
æ‰€æœ‰å·¥å…·å®ç°å¿…é¡»ï¼š
1. å¿…å¡«å­—æ®µæ ¡éªŒ: tenant_user_id å¿…é¡»å­˜åœ¨ä¸”éç©º
2. æƒé™æ ¡éªŒ: éªŒè¯ tenant_user_id æœ‰æƒè®¿é—®è¯·æ±‚çš„èµ„æºï¼ˆå¥½å‹/ç¾¤/æ¶ˆæ¯ï¼‰
3. å‚æ•°ç±»å‹æ ¡éªŒ: ä¸¥æ ¼æŒ‰ç…§ JSON Schema éªŒè¯å‚æ•°ç±»å‹
4. è¾¹ç•Œå€¼æ ¡éªŒ: 
   - page >= 1
   - page_size èŒƒå›´ 1, 200
   - limit èŒƒå›´ 1, 100
4.5 è¾“å‡ºæ ¼å¼è§„èŒƒ
æ‰€æœ‰å·¥å…·è¾“å‡ºå¿…é¡»åŒ…å«ï¼š
1. content (å¿…å¡«): æ•°ç»„ï¼ŒåŒ…å«è‡³å°‘ä¸€ä¸ª TextContent
   - type: "text"
   - text: äººç±»å¯è¯»çš„ç»“æœæè¿°
2. metadata (å¯é€‰): ç»“æ„åŒ–æ•°æ®ï¼Œä¾›åç»­å¤„ç†ä½¿ç”¨
3. isError (å¯é€‰): å¸ƒå°”å€¼ï¼Œæ ‡è¯†æ˜¯å¦ä¸ºé”™è¯¯ç»“æœ
---


äº”ã€MCP è°ƒåº¦å™¨è®¾è®¡
5.1 MCPDispatcher æ ¸å¿ƒèŒè´£
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MCPDispatcher                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  èŒè´£ï¼š                                                  â”‚
â”‚  1. æ¥æ”¶ LLM çš„å·¥å…·è°ƒç”¨è¯·æ±‚ (tool_call)                  â”‚
â”‚  2. è·¯ç”±åˆ°æ­£ç¡®çš„ MCP Server (å†…ç½® or å¤–éƒ¨)               â”‚
â”‚  3. æ‰§è¡Œå·¥å…·è°ƒç”¨                                         â”‚
â”‚  4. è½¬æ¢ç»“æœæ ¼å¼                                         â”‚
â”‚  5. è¿”å›ç»™ AI Pipeline                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®Œæ•´æ¶æ„å¯¹æ¯”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MCPDispatcher                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç»Ÿä¸€è°ƒåº¦æ‰€æœ‰å·¥å…·ï¼ˆå†…ç½® + å¤–éƒ¨ï¼‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“                    â†“                    â†“
    
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å†…ç½® MCP Server  â”‚  â”‚ å¤–éƒ¨ Server      â”‚  â”‚ å¤–éƒ¨ Server      â”‚
â”‚ (æ— ä¼ è¾“å±‚)       â”‚  â”‚ (Stdio)          â”‚  â”‚ (HTTP)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç›´æ¥å‡½æ•°è°ƒç”¨ âœ“   â”‚  â”‚ å­è¿›ç¨‹é€šä¿¡       â”‚  â”‚ HTTP è¯·æ±‚        â”‚
â”‚ é›¶å»¶è¿Ÿ          â”‚  â”‚ ä½å»¶è¿Ÿ (~1ms)    â”‚  â”‚ ç½‘ç»œå»¶è¿Ÿ (~50ms) â”‚
â”‚ ç±»å‹å®‰å…¨        â”‚  â”‚ JSON åºåˆ—åŒ–      â”‚  â”‚ JSON åºåˆ—åŒ–      â”‚
â”‚ å…±äº«æ•°æ®åº“      â”‚  â”‚ éš”ç¦»è¿›ç¨‹         â”‚  â”‚ è¿œç¨‹æœåŠ¡         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“                     â†“                     â†“
ContactService       GitHub CLI           Google Calendar API
GroupService         Filesystem           Notion API
MessageService       ...                  ...
---


5.2 æ¥å£å®šä¹‰
// internal/modules/ai/application/service/mcp_dispatcher.go
package service
import (
    "context"
    "OmniLink/internal/modules/ai/infrastructure/mcp/types"
)
// MCPDispatcher MCP è°ƒåº¦å™¨æ¥å£
type MCPDispatcher interface {
    // ListAvailableTools åˆ—å‡ºæ‰€æœ‰å¯ç”¨å·¥å…·
    ListAvailableTools(ctx context.Context, tenantUserID string) ([]types.ToolDescriptor, error)
    
    // CallTool è°ƒç”¨æŒ‡å®šå·¥å…·
    CallTool(ctx context.Context, req *ToolCallRequest) (*ToolCallResponse, error)
    
    // GetToolByName æ ¹æ®åç§°æŸ¥æ‰¾å·¥å…·
    GetToolByName(ctx context.Context, name string) (*types.ToolDescriptor, error)
    
    // RefreshServers é‡æ–°åŠ è½½ MCP Server é…ç½®
    RefreshServers(ctx context.Context) error
}
// ToolCallRequest å·¥å…·è°ƒç”¨è¯·æ±‚
type ToolCallRequest struct {
    TenantUserID string                 // ç§Ÿæˆ·ç”¨æˆ· ID (å¿…å¡«)
    ToolName     string                 // å·¥å…·åç§° (å¿…å¡«)
    Arguments    map[string]interface{} // å·¥å…·å‚æ•°
    Timeout      int                    // è¶…æ—¶æ—¶é—´ (ç§’)ï¼Œ0 è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼
}
// ToolCallResponse å·¥å…·è°ƒç”¨å“åº”
type ToolCallResponse struct {
    Success  bool                   // æ˜¯å¦æˆåŠŸ
    Content  string                 // æ–‡æœ¬å†…å®¹ (ç»™ LLM çœ‹çš„)
    Metadata map[string]interface{} // ç»“æ„åŒ–æ•°æ® (å¯é€‰)
    Error    string                 // é”™è¯¯ä¿¡æ¯ (å¦‚æœå¤±è´¥)
}
5.3 å·¥ä½œæµç¨‹
sequenceDiagram
    participant LLM as LLM (ChatModel)
    participant Pipe as AssistantPipeline
    participant Disp as MCPDispatcher
    participant Router as ToolRouter
    participant Builtin as BuiltinMCPServer
    participant External as ExternalMCPClient
    LLM->>Pipe: è¿”å› tool_call (name=contact_list_friends)
    Pipe->>Disp: CallTool(name, args)
    Disp->>Router: RouteToolCall(name)
    Router-->>Disp: è¿”å› target=BuiltinServer
    Disp->>Builtin: ExecuteTool(name, args)
    Builtin->>Builtin: è°ƒç”¨ ContactService.GetUserList()
    Builtin-->>Disp: è¿”å›ç»“æœ
    Disp->>Disp: è½¬æ¢ä¸º ToolCallResponse
    Disp-->>Pipe: è¿”å›ç»“æœ
    Pipe->>LLM: å°†ç»“æœä½œä¸º tool_result å›å¡«
    LLM-->>Pipe: ç”Ÿæˆæœ€ç»ˆå›ç­”
---

å…­ã€internal/modules/ai/infrastructure/mcp/ ç›®å½•è®¾è®¡
6.1 æ ¸å¿ƒç»„ä»¶è¯´æ˜
A. MCP Client (client/mcp_client.go)
èŒè´£:
- ç®¡ç†ä¸å¤–éƒ¨ MCP Server çš„è¿æ¥
- å¤„ç† JSON-RPC 2.0 æ¶ˆæ¯åºåˆ—åŒ–/ååºåˆ—åŒ–
- æ‰§è¡Œ initialize â†’ initialized æ¡æ‰‹
- è°ƒç”¨ tools/listã€tools/call ç­‰æ–¹æ³•
æ ¸å¿ƒæ¥å£:
type MCPClient interface {
    // Initialize åˆå§‹åŒ–è¿æ¥ï¼ˆæ¡æ‰‹ï¼‰
    Initialize(ctx context.Context, clientInfo ClientInfo) (*InitializeResult, error)
    
    // ListTools è·å– Server æä¾›çš„å·¥å…·åˆ—è¡¨
    ListTools(ctx context.Context) ([]ToolDescriptor, error)
    
    // CallTool è°ƒç”¨æŒ‡å®šå·¥å…·
    CallTool(ctx context.Context, name string, args map[string]interface{}) (*CallToolResult, error)
    
    // Close å…³é—­è¿æ¥
    Close(ctx context.Context) error
}
B. Server Registry (registry/server_registry.go)
èŒè´£:
- æ³¨å†Œå†…ç½® MCP Server
- æ³¨å†Œå¤–éƒ¨ MCP Server (ä»é…ç½®åŠ è½½)
- ç®¡ç† Server ç”Ÿå‘½å‘¨æœŸ (å¯åŠ¨/åœæ­¢/é‡å¯)
- æä¾› Server æŸ¥è¯¢æ¥å£
æ ¸å¿ƒæ¥å£:
type ServerRegistry interface {
    // RegisterBuiltinServer æ³¨å†Œå†…ç½® Server
    RegisterBuiltinServer(server MCPServer) error
    
    // RegisterExternalServer æ³¨å†Œå¤–éƒ¨ Server
    RegisterExternalServer(config MCPExternalServerConfig) error
    
    // GetServerByName æ ¹æ®åç§°è·å– Server
    GetServerByName(name string) (RegisteredServer, error)
    
    // ListServers åˆ—å‡ºæ‰€æœ‰å·²æ³¨å†Œçš„ Server
    ListServers() []RegisteredServer
    
    // StartAll å¯åŠ¨æ‰€æœ‰ Server
    StartAll(ctx context.Context) error
    
    // StopAll åœæ­¢æ‰€æœ‰ Server
    StopAll(ctx context.Context) error
}
type RegisteredServer struct {
    Name      string
    Type      string  // builtin | external
    Priority  int
    Status    string  // running | stopped | error
    Client    MCPClient  // å¤–éƒ¨ Server çš„å®¢æˆ·ç«¯è¿æ¥
    Server    MCPServer  // å†…ç½® Server å®ä¾‹
}
C. Tool Router (router/tool_router.go)
èŒè´£:
- æ ¹æ®å·¥å…·åç§°è·¯ç”±åˆ°æ­£ç¡®çš„ MCP Server
- å®ç°è·¯ç”±ç­–ç•¥ (ä¼˜å…ˆçº§ã€è½®è¯¢ã€éšæœº)
- ç¼“å­˜å·¥å…·åˆ—è¡¨ (å‡å°‘é‡å¤æŸ¥è¯¢)
æ ¸å¿ƒæ¥å£:
type ToolRouter interface {
    // RouteToolCall è·¯ç”±å·¥å…·è°ƒç”¨
    RouteToolCall(ctx context.Context, toolName string) (*RouteTarget, error)
    
    // ListAllTools åˆ—å‡ºæ‰€æœ‰ Server çš„å·¥å…·
    ListAllTools(ctx context.Context) ([]ToolDescriptor, error)
    
    // RefreshToolCache åˆ·æ–°å·¥å…·ç¼“å­˜
    RefreshToolCache(ctx context.Context) error
}
type RouteTarget struct {
    ServerName string
    ServerType string  // builtin | external
    Tool       ToolDescriptor
}
D. Builtin MCP Server (server/builtin_server.go)
èŒè´£:
- å®ç° MCP Server åè®®
- å°è£… OmniLink å†…éƒ¨èƒ½åŠ›ï¼ˆContact/Group/Message/Session Servicesï¼‰
- æ³¨å†Œå·¥å…·åˆ° ToolRegistry
- å¤„ç† tools/list å’Œ tools/call è¯·æ±‚
æ ¸å¿ƒæ¥å£:
type MCPServer interface {
    // GetServerInfo è·å– Server åŸºæœ¬ä¿¡æ¯
    GetServerInfo() ServerInfo
    
    // ListTools åˆ—å‡ºæ‰€æœ‰å·¥å…·
    ListTools(ctx context.Context) ([]ToolDescriptor, error)
    
    // CallTool æ‰§è¡Œå·¥å…·è°ƒç”¨
    CallTool(ctx context.Context, name string, args map[string]interface{}) (*CallToolResult, error)
}
type ServerInfo struct {
    Name        string
    Version     string
    Description string
}
---
ä¸ƒã€é›†æˆåˆ° AssistantPipeline çš„æ–¹æ¡ˆ
7.1 ä¿®æ”¹ AssistantPipeline ä»¥æ”¯æŒ Tool Calling
æ–¹æ¡ˆ A: åœ¨ chatModelNode åå¢åŠ  ToolCallNode (æ¨è)
å½“å‰æµç¨‹:
  LoadMemory â†’ Retrieve â†’ BuildPrompt â†’ ChatModel â†’ Persist
ä¿®æ”¹åæµç¨‹:
  LoadMemory â†’ Retrieve â†’ BuildPrompt â†’ ChatModel â†’ [ToolCall] â†’ [ChatModel Again] â†’ Persist
                                           â†“ (å¦‚æœ LLM è¿”å› tool_call)
                                      MCPDispatcher
                                           â†“
                                      æ‰§è¡Œå·¥å…·ï¼Œå›å¡«ç»“æœ
                                           â†“
                                      è¿”å› ChatModel ç»§ç»­ç”Ÿæˆ
å¢å¼ºçš„ chatModelNode é€»è¾‘:
// ä¼ªä»£ç 
func (p *AssistantPipeline) chatModelNode(ctx context.Context, st *assistantState) (*assistantState, error) {
    // ç¬¬ä¸€æ¬¡è°ƒç”¨ LLM
    response := chatModel.Generate(st.PromptMsgs)
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ tool_call
    if response.HasToolCalls() {
        // è°ƒç”¨ MCPDispatcher
        for _, toolCall := range response.ToolCalls {
            result := mcpDispatcher.CallTool(ctx, &ToolCallRequest{
                TenantUserID: st.Req.TenantUserID,
                ToolName:     toolCall.Name,
                Arguments:    toolCall.Arguments,
            })
            
            // å°†å·¥å…·ç»“æœæ·»åŠ åˆ°æ¶ˆæ¯å†å²
            st.PromptMsgs = append(st.PromptMsgs, schema.Message{
                Role: "tool",
                Name: toolCall.Name,
                Content: result.Content,
            })
        }
        
        // ç¬¬äºŒæ¬¡è°ƒç”¨ LLM (ç”Ÿæˆæœ€ç»ˆå›ç­”)
        finalResponse := chatModel.Generate(st.PromptMsgs)
        st.Answer = finalResponse.Content
    } else {
        st.Answer = response.Content
    }
    
    return st, nil
}
7.2 é…ç½® LLM ä½¿ç”¨ Tool
åœ¨ buildPromptNode ä¸­ï¼Œéœ€è¦å°†å¯ç”¨å·¥å…·åˆ—è¡¨ä¼ é€’ç»™ LLMï¼š
func (p *AssistantPipeline) buildPromptNode(ctx context.Context, st *assistantState) (*assistantState, error) {
    // ... ç°æœ‰é€»è¾‘ ...
    
    // æ–°å¢ï¼šè·å–å¯ç”¨å·¥å…·åˆ—è¡¨
    if p.mcpDispatcher != nil {
        tools, err := p.mcpDispatcher.ListAvailableTools(ctx, st.Req.TenantUserID)
        if err == nil {
            st.AvailableTools = tools  // ä¿å­˜åˆ° state
        }
    }
    
    return st, nil
}
// ç„¶ååœ¨ chatModelNode è°ƒç”¨ LLM æ—¶ï¼š
func (p *AssistantPipeline) chatModelNode(ctx context.Context, st *assistantState) (*assistantState, error) {
    // æ„é€  LLM è¯·æ±‚ï¼ŒåŒ…å« tools å‚æ•°
    llmRequest := &LLMRequest{
        Messages: st.PromptMsgs,
        Tools:    convertToolsToLLMFormat(st.AvailableTools),  // è½¬æ¢ä¸º OpenAI/Claude æ ¼å¼
    }
    
    response := p.chatModel.Generate(ctx, llmRequest)
    // ... åç»­å¤„ç† ...
}
---
å…«ã€å·¥å…·å®ç°ç¤ºä¾‹ï¼ˆä»…å±•ç¤ºç»“æ„ï¼Œä¸å†™å®Œæ•´ä»£ç ï¼‰
8.1 å†…ç½® Server å·¥å…· Handler ç»“æ„
// internal/modules/ai/infrastructure/mcp/server/handlers/contact_handler.go
package handlers
import (
    "context"
    contactService "OmniLink/internal/modules/contact/application/service"
    "OmniLink/internal/modules/ai/infrastructure/mcp/types"
)
type ContactToolHandler struct {
    contactSvc contactService.ContactService
}
func NewContactToolHandler(svc contactService.ContactService) *ContactToolHandler {
    return &ContactToolHandler{contactSvc: svc}
}
// RegisterTools æ³¨å†Œæ‰€æœ‰å¥½å‹ç›¸å…³å·¥å…·
func (h *ContactToolHandler) RegisterTools() []types.ToolDescriptor {
    return []types.ToolDescriptor{
        {
            Name:        "contact_list_friends",
            Description: "è·å–ç”¨æˆ·çš„å¥½å‹åˆ—è¡¨",
            InputSchema: map[string]interface{}{
                "type": "object",
                "properties": map[string]interface{}{
                    "tenant_user_id": map[string]string{"type": "string"},
                },
                "required": []string{"tenant_user_id"},
            },
            Handler: h.handleListFriends,  // ç»‘å®šå¤„ç†å‡½æ•°
        },
        // ... å…¶ä»–å·¥å…·
    }
}
// handleListFriends å®ç°å…·ä½“é€»è¾‘
func (h *ContactToolHandler) handleListFriends(ctx context.Context, args map[string]interface{}) (*types.CallToolResult, error) {
    // 1. å‚æ•°æ ¡éªŒ
    tenantUserID := args["tenant_user_id"].(string)
    
    // 2. è°ƒç”¨ ContactService
    friends, err := h.contactSvc.GetUserList(contactRequest.GetUserListRequest{
        OwnerId: tenantUserID,
    })
    
    // 3. è½¬æ¢ä¸º MCP ç»“æœæ ¼å¼
    return &types.CallToolResult{
        Content: []types.Content{
            {
                Type: "text",
                Text: formatFriendsAsText(friends),  // è½¬æ¢ä¸ºäººç±»å¯è¯»æ–‡æœ¬
            },
        },
        Metadata: map[string]interface{}{
            "friends": friends,
            "total":   len(friends),
        },
    }, nil
}
---
ä¹ã€å…³é”®æŠ€æœ¯å†³ç­–
9.1 ä¸ºä»€ä¹ˆé€‰æ‹© JSON-RPC 2.0ï¼Ÿ
- å®˜æ–¹æ ‡å‡†: MCP å®˜æ–¹è§„èŒƒè¦æ±‚ä½¿ç”¨ JSON-RPC 2.0
- ç®€å•å¯é : æˆç†Ÿçš„ RPC åè®®ï¼Œæ˜“äºè°ƒè¯•
- åŒå‘é€šä¿¡: æ”¯æŒè¯·æ±‚-å“åº” + é€šçŸ¥æ¨¡å¼
9.2 ä¸ºä»€ä¹ˆæ”¯æŒ Stdio å’Œ HTTP ä¸¤ç§ä¼ è¾“ï¼Ÿ
- Stdio: æœ¬åœ°è¿›ç¨‹é€šä¿¡ï¼Œå®‰å…¨æ€§é«˜ï¼Œé€‚åˆæœ¬åœ°å·¥å…· (GitHub CLI, æ–‡ä»¶ç³»ç»Ÿ)
- HTTP: è¿œç¨‹æœåŠ¡è°ƒç”¨ï¼Œé€‚åˆäº‘ç«¯ API (Google Calendar, Notion)
9.3 ä¸ºä»€ä¹ˆéœ€è¦ ToolRouterï¼Ÿ
- å¤š Server åœºæ™¯: å¯èƒ½æœ‰ 10+ ä¸ª MCP Serverï¼Œæ¯ä¸ªæä¾›ä¸åŒå·¥å…·
- å†²çªè§£å†³: ä¸¤ä¸ª Server å¯èƒ½æä¾›åŒåå·¥å…·ï¼Œéœ€è¦ä¼˜å…ˆçº§ç­–ç•¥
- æ€§èƒ½ä¼˜åŒ–: ç¼“å­˜å·¥å…·åˆ—è¡¨ï¼Œé¿å…é‡å¤è°ƒç”¨ tools/list
9.4 ä¸ºä»€ä¹ˆå†…ç½® Server ä¹Ÿè¦å®ç° MCP åè®®ï¼Ÿ
- ç»Ÿä¸€æ¥å£: å†…å¤–éƒ¨ Server ä½¿ç”¨ç›¸åŒæ¥å£ï¼Œç®€åŒ– Dispatcher é€»è¾‘
- å¯æ’æ‹”: æœªæ¥å¯ä»¥å°†å†…ç½® Server æ‹†åˆ†ä¸ºç‹¬ç«‹è¿›ç¨‹
- å¯æµ‹è¯•: å†…ç½® Server å¯ä»¥ç‹¬ç«‹æµ‹è¯•ï¼Œæ— éœ€å¯åŠ¨æ•´ä¸ªåº”ç”¨
---
åã€æœ€å°å¯è¡Œå®ç°ï¼ˆMVPï¼‰è·¯çº¿å›¾
Phase 1: æ ¸å¿ƒæ¡†æ¶ (1-2 å¤©)
1. âœ… å®šä¹‰ MCP é…ç½®ç»“æ„ (TOML + Go struct)
2. âœ… å®ç° types/protocol.go (JSON-RPC ç±»å‹å®šä¹‰)
3. âœ… å®ç° registry/server_registry.go (Server æ³¨å†Œè¡¨)
4. âœ… å®ç° MCPDispatcher æ¥å£
Phase 2: å†…ç½® Server (2-3 å¤©)
1. âœ… å®ç° server/builtin_server.go
2. âœ… å®ç° handlers/contact_handler.go (5 ä¸ªå·¥å…·)
3. âœ… å®ç° handlers/group_handler.go (3 ä¸ªå·¥å…·)
4. âœ… é›†æˆæµ‹è¯•ï¼šè°ƒç”¨å†…ç½®å·¥å…·
Phase 3: å¤–éƒ¨ Server æ”¯æŒ (2-3 å¤©)
1. âœ… å®ç° client/transport_stdio.go (Stdio ä¼ è¾“)
2. âœ… å®ç° client/mcp_client.go (JSON-RPC å®¢æˆ·ç«¯)
3. âœ… å®ç° router/tool_router.go (å·¥å…·è·¯ç”±)
4. âœ… é›†æˆæµ‹è¯•ï¼šè¿æ¥å¤–éƒ¨ MCP Server (å¦‚ @modelcontextprotocol/server-filesystem)
Phase 4: Pipeline é›†æˆ (1-2 å¤©)
1. âœ… ä¿®æ”¹ AssistantPipeline æ”¯æŒ tool calling
2. âœ… ä¿®æ”¹ chatModelNode å®ç°å·¥å…·è°ƒç”¨å¾ªç¯
3. âœ… ç«¯åˆ°ç«¯æµ‹è¯•ï¼šç”¨æˆ·é—®"æˆ‘æœ‰å“ªäº›å¥½å‹" â†’ LLM è°ƒç”¨ contact_list_friends â†’ è¿”å›ç»“æœ
---
åä¸€ã€æœ€ç»ˆäº¤ä»˜ç‰©
11.1 é…ç½®æ–‡ä»¶
- configs/config.toml - æ–°å¢ [mcpConfig] é…ç½®æ®µ
- internal/config/config.go - æ–°å¢ MCPConfig ç»“æ„ä½“
11.2 æ ¸å¿ƒä»£ç æ–‡ä»¶ï¼ˆä»…ç»“æ„ï¼Œä¸å«å®ç°ï¼‰
internal/modules/ai/
â”œâ”€â”€ application/service/mcp_dispatcher.go        (æ¥å£å®šä¹‰)
â”œâ”€â”€ infrastructure/mcp/
â”‚   â”œâ”€â”€ types/protocol.go                        (MCP åè®®ç±»å‹)
â”‚   â”œâ”€â”€ types/tool.go                            (Tool å®šä¹‰)
â”‚   â”œâ”€â”€ types/errors.go                          (é”™è¯¯å®šä¹‰)
â”‚   â”œâ”€â”€ client/mcp_client.go                     (MCP Client å®ç°)
â”‚   â”œâ”€â”€ client/session_manager.go                (Session ç®¡ç†)
â”‚   â”œâ”€â”€ client/transport_stdio.go                (Stdio ä¼ è¾“)
â”‚   â”œâ”€â”€ server/builtin_server.go                 (å†…ç½® Server)
â”‚   â”œâ”€â”€ server/tool_registry.go                  (å·¥å…·æ³¨å†Œè¡¨)
â”‚   â”œâ”€â”€ server/handlers/contact_handler.go       (å¥½å‹å·¥å…·)
â”‚   â”œâ”€â”€ server/handlers/group_handler.go         (ç¾¤ç»„å·¥å…·)
â”‚   â”œâ”€â”€ server/handlers/message_handler.go       (æ¶ˆæ¯å·¥å…·)
â”‚   â”œâ”€â”€ registry/server_registry.go              (Server æ³¨å†Œè¡¨)
â”‚   â””â”€â”€ router/tool_router.go                    (å·¥å…·è·¯ç”±)
11.3 æ–‡æ¡£
- å·¥å…·è§„èŒƒæ–‡æ¡£: æ‰€æœ‰ 16 ä¸ªå†…ç½®å·¥å…·çš„ JSON Schema å®šä¹‰
- é…ç½®æŒ‡å—: å¦‚ä½•æ·»åŠ å¤–éƒ¨ MCP Server
- å¼€å‘æŒ‡å—: å¦‚ä½•æ·»åŠ æ–°çš„å†…ç½®å·¥å…·
---
åäºŒã€åç»­æ‰©å±•æ–¹å‘
1. å·¥å…·æƒé™æ§åˆ¶: åŸºäºç”¨æˆ·è§’è‰²é™åˆ¶å¯ç”¨å·¥å…·
2. å·¥å…·ä½¿ç”¨å®¡è®¡: è®°å½•æ‰€æœ‰å·¥å…·è°ƒç”¨æ—¥å¿—
3. å·¥å…·ç¼“å­˜: ç¼“å­˜é¢‘ç¹è°ƒç”¨å·¥å…·çš„ç»“æœ (å¦‚ list_friends)
4. å·¥å…·ç»„åˆ: æ”¯æŒä¸€æ¬¡è°ƒç”¨å¤šä¸ªå·¥å…·å¹¶èšåˆç»“æœ
5. HTTP Transport: å®ç°è¿œç¨‹ MCP Server æ”¯æŒ
6. Resource æ”¯æŒ: æ‰©å±•åˆ° MCP Resources (å¦‚"æˆ‘çš„èŠå¤©è®°å½•")
7. Prompt æ”¯æŒ: æ‰©å±•åˆ° MCP Prompts (å¦‚"å¸®æˆ‘å†™ä¸€å°é‚®ä»¶")
---
ä»¥ä¸Šå°±æ˜¯å®Œæ•´çš„ MCP æ¡†æ¶æ­å»ºè®¾è®¡æ–¹æ¡ˆï¼ ğŸ‰
è¿™ä¸ªæ–¹æ¡ˆï¼š
- âœ… ä¿æŒäº† DDD åˆ†å±‚æ¶æ„ä¸åŠ¨
- âœ… æ–°å¢ internal/modules/ai/infrastructure/mcp/ å®Œæ•´ç»“æ„
- âœ… å®šä¹‰äº† TOML é…ç½®è§„èŒƒ
- âœ… è§„èŒƒäº† 16 ä¸ªå†…ç½®å·¥å…·çš„æ¥å£å¥‘çº¦
- âœ… æä¾›äº† MCPDispatcher çš„è¯¦ç»†è®¾è®¡
- âœ… ç»™å‡ºäº†é›†æˆåˆ° AssistantPipeline çš„å…·ä½“æ–¹æ¡ˆ
- âœ… åŒ…å«æœ€å°å¯è¡Œå®ç°ï¼ˆMVPï¼‰è·¯çº¿å›¾
æ‰€æœ‰è®¾è®¡éƒ½éµå¾ªäº† OmniLink ç°æœ‰çš„æ¶æ„é£æ ¼å’ŒæŠ€æœ¯æ ˆï¼